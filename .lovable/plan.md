
# خطة تنفيذ إعادة تعيين كلمة المرور عبر OTP (WhatsApp)

## نظرة عامة على النظام

سيتم إنشاء نظام كامل لإعادة تعيين كلمة المرور باستخدام رمز OTP يُرسل عبر WhatsApp باستخدام خدمة UltraMsg.

## المكونات المطلوبة

### 1. جدول قاعدة البيانات الجديد: `password_reset_otps`

```text
الأعمدة:
- id (uuid) - المفتاح الأساسي
- phone (varchar) - رقم الهاتف
- otp_code (varchar) - كود OTP المشفر
- user_type (varchar) - نوع المستخدم (customer/merchant)
- expires_at (timestamp) - تاريخ انتهاء الصلاحية (5 دقائق)
- used (boolean) - هل تم استخدام الكود
- created_at (timestamp)
```

**سياسات RLS:**
- السماح بالإدراج للجميع (عبر Edge Function)
- لا حاجة لسياسات قراءة من الواجهة (Edge Function ستستخدم service_role)

### 2. Edge Function جديدة: `send-otp`

**المسؤوليات:**
- استلام رقم الهاتف ونوع المستخدم
- التحقق من وجود الرقم في جدول profiles أو customer_profiles
- إنشاء كود OTP عشوائي من 6 أرقام
- تخزين الكود في قاعدة البيانات (مشفر)
- إرسال الكود عبر UltraMsg API

**تفاصيل UltraMsg:**
```text
URL: https://api.ultramsg.com/instance161047/messages/chat
Method: POST
Params:
  - token: hq05qcn1vim9b24w
  - to: رقم الهاتف (بدون +)
  - body: رمز التحقق الخاص بك هو: {OTP}
```

### 3. Edge Function جديدة: `verify-otp`

**المسؤوليات:**
- استلام رقم الهاتف + كود OTP
- التحقق من صحة الكود وعدم انتهاء صلاحيته
- إرجاع رمز تحقق مؤقت (reset_token) صالح لـ 10 دقائق

### 4. Edge Function جديدة: `reset-password`

**المسؤوليات:**
- استلام reset_token + كلمة المرور الجديدة
- التحقق من صحة الرمز المؤقت
- تحديث كلمة المرور في Supabase Auth
- تعيين الكود كمستخدم (used = true)

### 5. مكون React جديد: `PasswordResetModal`

**الشاشات:**

```text
شاشة 1: إدخال رقم الهاتف
┌──────────────────────────────────┐
│     إعادة تعيين كلمة المرور      │
├──────────────────────────────────┤
│  📱 أدخل رقم هاتفك               │
│  ┌─────────────────────────────┐ │
│  │ 🇯🇴 +962 │ 7XX XXX XXX      │ │
│  └─────────────────────────────┘ │
│                                  │
│  [○ عميل]  [○ طباخ/ة]           │
│                                  │
│  ┌─────────────────────────────┐ │
│  │       إرسال الكود          │ │
│  └─────────────────────────────┘ │
└──────────────────────────────────┘

شاشة 2: إدخال كود OTP
┌──────────────────────────────────┐
│       أدخل كود التحقق           │
├──────────────────────────────────┤
│                                  │
│      ┌─┬─┬─┬─┬─┬─┐              │
│      │_│_│_│_│_│_│              │
│      └─┴─┴─┴─┴─┴─┘              │
│                                  │
│  تم إرسال الكود إلى: +962...    │
│  ⏱️ صالح لمدة 5 دقائق            │
│                                  │
│  ┌─────────────────────────────┐ │
│  │         تحقق               │ │
│  └─────────────────────────────┘ │
│                                  │
│  إعادة إرسال الكود؟             │
└──────────────────────────────────┘

شاشة 3: كلمة المرور الجديدة
┌──────────────────────────────────┐
│     كلمة المرور الجديدة         │
├──────────────────────────────────┤
│                                  │
│  🔐 كلمة المرور الجديدة          │
│  ┌─────────────────────────────┐ │
│  │ ••••••••             👁️    │ │
│  └─────────────────────────────┘ │
│                                  │
│  🔐 تأكيد كلمة المرور            │
│  ┌─────────────────────────────┐ │
│  │ ••••••••             👁️    │ │
│  └─────────────────────────────┘ │
│                                  │
│  ┌─────────────────────────────┐ │
│  │   تغيير كلمة المرور        │ │
│  └─────────────────────────────┘ │
└──────────────────────────────────┘

شاشة 4: النجاح
┌──────────────────────────────────┐
│                                  │
│            ✅                    │
│                                  │
│  تم تغيير كلمة المرور بنجاح!    │
│  يمكنك تسجيل الدخول الآن        │
│                                  │
│  ┌─────────────────────────────┐ │
│  │       تسجيل الدخول         │ │
│  └─────────────────────────────┘ │
└──────────────────────────────────┘
```

### 6. تحديث صفحة Auth.tsx

- إضافة زر "نسيت كلمة المرور؟" أسفل زر تسجيل الدخول
- فتح PasswordResetModal عند الضغط

---

## التفاصيل التقنية

### Secrets المطلوبة

```text
ULTRAMSG_INSTANCE_ID: instance161047
ULTRAMSG_TOKEN: hq05qcn1vim9b24w
```

### ترجمات جديدة (useLanguage.tsx)

```text
auth.forgotPassword - نسيت كلمة المرور؟
auth.resetPassword - إعادة تعيين كلمة المرور
auth.enterPhone - أدخل رقم هاتفك
auth.sendCode - إرسال الكود
auth.enterOtp - أدخل كود التحقق
auth.codeSentTo - تم إرسال الكود إلى
auth.validFor - صالح لمدة 5 دقائق
auth.verify - تحقق
auth.resendCode - إعادة إرسال الكود
auth.newPassword - كلمة المرور الجديدة
auth.changePassword - تغيير كلمة المرور
auth.passwordChanged - تم تغيير كلمة المرور بنجاح!
auth.canLoginNow - يمكنك تسجيل الدخول الآن
auth.phoneNotFound - رقم الهاتف غير مسجل
auth.invalidOtp - كود التحقق غير صحيح
auth.otpExpired - انتهت صلاحية الكود
auth.otpSent - تم إرسال الكود بنجاح
```

### تحديث supabase/config.toml

```toml
[functions.send-otp]
verify_jwt = false

[functions.verify-otp]
verify_jwt = false

[functions.reset-password]
verify_jwt = false
```

---

## الملفات المتأثرة

| الملف | نوع التغيير |
|-------|-------------|
| `src/pages/Auth.tsx` | تعديل (إضافة زر + modal) |
| `src/components/PasswordResetModal.tsx` | **جديد** |
| `src/hooks/useLanguage.tsx` | تعديل (ترجمات جديدة) |
| `supabase/functions/send-otp/index.ts` | **جديد** |
| `supabase/functions/verify-otp/index.ts` | **جديد** |
| `supabase/functions/reset-password/index.ts` | **جديد** |
| `supabase/config.toml` | تعديل |
| Database migration | **جديد** (جدول password_reset_otps) |

---

## أمان النظام

1. **تشفير OTP**: يتم تخزين الكود مشفراً في قاعدة البيانات
2. **انتهاء الصلاحية**: 5 دقائق للكود، 10 دقائق للـ reset_token
3. **استخدام واحد**: الكود يصبح غير صالح بعد الاستخدام
4. **Rate Limiting**: تحديد عدد المحاولات لمنع الإساءة
5. **التحقق من الهاتف**: التأكد من وجود الرقم في النظام قبل الإرسال

---

## ملاحظات مهمة

- مفاتيح UltraMsg ستُحفظ كـ Secrets آمنة
- النظام يدعم كلا النوعين (عميل/طباخ) لأن لكل نوع جدول منفصل
- يتم إرسال الرسالة بالعربية لتناسب المستخدمين
